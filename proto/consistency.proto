syntax = "proto3";

package dann;

import "node_management.proto";

// Consistency management service
service ConsistencyService {
  // Propagate operation
  rpc PropagateOperation(PropagateOperationRequest) returns (PropagateOperationResponse);
  
  // Resolve conflicts
  rpc ResolveConflict(ResolveConflictRequest) returns (ResolveConflictResponse);
  
  // Get vector clock
  rpc GetVectorClock(GetVectorClockRequest) returns (GetVectorClockResponse);
  
  // Update vector clock
  rpc UpdateVectorClock(UpdateVectorClockRequest) returns (UpdateVectorClockResponse);
  
  // Anti-entropy sync
  rpc AntiEntropySync(AntiEntropySyncRequest) returns (AntiEntropySyncResponse);
}

// Vector clock entry
message VectorClockEntry {
  string node_id = 1;
  int64 timestamp = 2;
}

// Vector clock
message VectorClock {
  repeated VectorClockEntry entries = 1;
}

// Propagate operation request
message PropagateOperationRequest {
  IndexOperation operation = 1;
  VectorClock clock = 2;
  string source_node = 3;
  repeated string target_nodes = 4;
}

// Propagate operation response
message PropagateOperationResponse {
  bool success = 1;
  string error_message = 2;
  string operation_id = 3;
}

// Resolve conflict request
message ResolveConflictRequest {
  string vector_id = 1;
  repeated IndexOperation conflicting_operations = 2;
  VectorClock local_clock = 3;
}

// Resolve conflict response
message ResolveConflictResponse {
  bool success = 1;
  string error_message = 2;
  IndexOperation resolved_operation = 3;
  VectorClock updated_clock = 4;
}

// Get vector clock request
message GetVectorClockRequest {
  string vector_id = 1;
}

// Get vector clock response
message GetVectorClockResponse {
  bool success = 1;
  string error_message = 2;
  VectorClock clock = 3;
}

// Update vector clock request
message UpdateVectorClockRequest {
  string vector_id = 1;
  VectorClock clock = 2;
}

// Update vector clock response
message UpdateVectorClockResponse {
  bool success = 1;
  string error_message = 2;
}

// Anti-entropy sync request
message AntiEntropySyncRequest {
  string requesting_node = 1;
  int32 shard_id = 2;
  int64 from_version = 3;
  map<string, int64> vector_versions = 4;
}

// Anti-entropy sync response
message AntiEntropySyncResponse {
  bool success = 1;
  string error_message = 2;
  repeated IndexOperation missing_operations = 3;
  map<string, int64> vector_versions = 4;
  int64 latest_version = 5;
}
